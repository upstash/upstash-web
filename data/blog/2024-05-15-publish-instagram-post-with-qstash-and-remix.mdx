---
slug: publish-instagram-post-with-qstash-and-remix
title: "Streamline Instagram Posts: Using Remix and QStash"
authors:
  - amit
tags: [qstash, remix, fly.io]
---

In this guide, you'll learn how to publish an Instagram post without making your users wait long for it to be published on Instagram.

## Prerequisites

You'll need the following:

- **[Node.js 18](https://nodejs.org/en/blog/announcements/v18-release-announce)**Â or later
- AnÂ **[Upstash](https://upstash.com/)**Â account
- **[Meta for Developers](https://developers.facebook.com/apps/)** account
- AÂ **[Fly.io](https://fly.io/)**Â Account

## Tech Stack

| Technology                             | Description                                                                     |
| -------------------------------------- | ------------------------------------------------------------------------------- |
| [Upstash](https://upstash.com)         | QStash is a message queue and task scheduler designed for serverless runtimes.  |
| [Remix](https://remix.run)             | A framework for building full-stack web applications with a focus on Web Standards. |
| [Tailwindcss](https://tailwindcss.com) | A CSS framework for building custom designs.                                      |
| [Fly.io](https://fly.io)               | A platform for running full-stack apps and databases close to your users.       |

## Steps

To complete this guide and deploy your own article recommendation system, you'll need to follow these steps:

- **[Set up the Remix project](#set-up-the-project)**
- **[Obtain the QStash secret key](#obtain-the-qstash-secret-key)**
- **[Create a Cloudflare Workers Endpoint](#create-a-cloudflare-workers-endpoint)**
- **[Create a callback Endpoint](#create-a-callback-endpoint)**
- **[Create a QStash with a scheduler](#create-a-qstash-with-a-scheduler)**
- **[Deploy To Fly.io](#deploy-to-flyio)**
- **[Conclusion](#conclusion)**

## **Set up the project**

To set up the Remix project, please follow along with the following link that will guide you to learn everything that's in it.

```bash
# run the following command to create a remix template
npx create-remix@latest --template remix-run/blues-stack

# Install the dependencies
npm install
```

## **Obtain the QStash secret key**

Once you have created an Upstash account and are logged in, go to the QStash tab.

Now, scroll down until you see theÂ **Environment KeysÂ section**, and click theÂ **copy**Â button and save it somewhere safe to be used further in your application.

![QStash.png](/blog/qstash/env-keys.png)

Once you have set up the Remix project, create anÂ `.env`Â file if it doesnât exist. You are going to add the secret keys obtained in the sections above.

TheÂ `.env`Â file should contain the following keys:

```bash
##REQUIRED FOR SENDING
QSTASH_URL="https://qstash.upstash.io/v2/publish/"
QSTASH_TOKEN="<your-qstash-token>"

##REQUIRED FOR RECEIVING
QSTASH_CURRENT_SIGNING_KEY="<your-current-signing-key>"
QSTASH_NEXT_SIGNING_KEY="<your-next-signing-key>"
```

With that done, the configuration setup is complete on your end. You can now see the application in action by executing the following command in your terminal and visitingÂ **[localhost:3000](http://localhost:3000/)**.

```bash
npm run dev
```

Follow along to understand the relevant parts of the code that allow you to successfully build your own Instagram post engine.

## **Create a Cloudflare Workers Endpoint**

We will create a Cloudflare Workers endpoint with the following command.

```bash
# You donât need a Cloudflare Workers endpoint to implement the QStash feature.
# You can build on any endpoint.
# this will install the Cloudflare packages and lead you through setup.

npm create cloudflare@latest
```

Once setup is complete copy the following code into your index.(js|ts) file

```tsx
import { Receiver } from "@upstash/qstash";

export interface Env {
  QSTASH_CURRENT_SIGNING_KEY: string;
  QSTASH_NEXT_SIGNING_KEY: string;
}

export default {
  async fetch(
    request: Request,
    env: Env,
    ctx: ExecutionContext,
  ): Promise<Response> {
    const c = new Receiver({
      currentSigningKey: env.QSTASH_CURRENT_SIGNING_KEY,
      nextSigningKey: env.QSTASH_NEXT_SIGNING_KEY,
    });

    const body = await request.text();

    const isValid = await c
      .verify({
        signature: request.headers.get("Upstash-Signature")!,
        body,
      })
      ...
    return new Response(body);
  },
};
```

## **Create a callback Endpoint**

A callback endpoint is necessary because once we initiate the QStash with a scheduler, the destination endpoint (in our case, a Cloudflare Worker) will call our callback endpoint and provide the necessary information.

```tsx
// Assuming that you have already created a container using the following API:
// https://graph.facebook.com/v19.0/${igBusinessId}/media?image_url=${mediaUrl}&caption=${encodedCaption}&access_token=${profileKey}

// file name - api.instagram.post.callback.tsx

// use case - to publish the Instagram post on the user's account.
// you can build any use case to run a background job.
/*
Steps:
1. create IG media container
2. check the status of the media container ID
3. once the container is ready to publish with a status code - `FINISHED`, we are
ready to publish the post on user account
*/

import { json } from "@remix-run/node";
import type { ActionFunctionArgs } from "@remix-run/node";
import { Client, Receiver } from "@upstash/qstash";

const...
```