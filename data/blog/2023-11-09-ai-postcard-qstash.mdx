---
slug: ai-postcard-qstash
title: "How to Create an AI Postcard Sender with Upstash QStash"
authors:
  - cameron
tags: [ai, qstash]
---

In this article, we will look at how to create an AI Postcard sending app at a high level. We will focus mainly on scheduling tasks with [Upstash QStash](https://upstash.com/docs/qstash/overall/getstarted), a serverless message queue and task scheduler.

This app uses the [Next.js 13 App Router](https://nextjs.org/) (hosted on [Vercel](https://vercel.com/)), [Upstash QStash](https://upstash.com/docs/qstash/overall/getstarted) for task scheduling, [Upstash Redis](https://upstash.com/docs/redis/overall/getstarted) for caching, [Replicate AI](https://replicate.com/) for [SDXL](https://stablediffusionxl.com/) image generation, and [Resend](https://resend.com/) for HTTP email sending.

## Project Setup

Go ahead and create a new Next.js project using the CLI. Make sure to enable the `App Router`. Configure the rest of the app as you like. This article will be using `tailwindCSS` and `typescript`. _Feel free to reference the [source code for this project on GitHub](https://github.com/alpinecodex/postcard)_.

```
npx create-next-app@latest
```

Install all necessary dependencies for this project:

```
npm install @upstash/qstash @upstash/redis replicate resend
```

Now that you have everything installed, go ahead and deploy the project to Vercel!

## Environment Variable Configuration

Create an `.env` file in the root of your Next.js project. Go ahead and add the following variables:

``` shell
REPLICATE_API_TOKEN=

UPSTASH_REDIS_REST_URL=
UPSTASH_REDIS_REST_TOKEN=

QSTASH_URL=
QSTASH_TOKEN=

RESEND_API_KEY=
```

Make sure that you **add your environment variables within Vercel** in your project settings as well! Otherwise, the app will **not** work.

_NOTE: To obtain all of these values, you will need an account with each of the services. But don't worry, they are free!_

Pay attention to the domain that your app is deployed on. This could be your own custom domain if you configured it, or a default one given by Vercel. We will need this domain for later in the project.

## App Architecture

Now that we have our project deployed to Vercel and are ready to start building, let's briefly review the app architecture. Here is the flow of the app:

1. A user fills out a form with an email address for the recipient, a body message for the email, a prompt for the image, and sets a date and time of day to send the postcard.
2. We handle the form submission on an API route and publish a message to QStash.
3. When the specified time approaches, QStash sends the message to another API route in our app. This API route catches the message from QStash, sends a request to Replicate to generate the image, and caches the ID of the Replicate generation in Redis along with our email information.
4. Once the image is finished generating, Replicate sends a webhook to another API route in our app. This route catches the webhook and retrieves the cached information from Redis by the Replicate generation ID. This key-value pair includes all necessary info for the email. We then send an email using Resend to the postcard recipient with the image attached.

![App Architecture](/blog/ai-postcard/architecture.png)

## Making the Form

Now that we understand how the app works, let's dive into writing some code!

We'll start by creating the form. To create a nice-looking form quickly, I am using [shadcn/ui](https://ui.shadcn.com/). However, you can use whatever you would like to create the form!

In a `components` directory in the root of your project, go ahead and create the file `form.tsx`. This form will have 5 inputs:

1. Email address of the recipient.
2. Message for the postcard (email body).
3. Prompt for the image.
4. Date to send the postcard (limited to the next 7 days).
5. Time of day to send (limited to morning, afternoon, and evening).

Here is a shortened version of the form I created. Reference the [GitHub repository](https://github.com/alpinecodex/postcard) for the full code:

```typescript
export default function MainForm() {
  const onSubmit = async (values: z.infer<typeof formSchema>) => {
    const timeMapping: Record<TimeKey, number> = {
      morning: 9,
      afternoon: 12,
      evening: 18,
    };

    const hour = timeMapping[values.time as TimeKey];

    the date = new Date(values.date);
    date.setHours(hour, 0, 0, 0);

    const timestamp = date.getTime() / 1000;

    const combinedValues = { ...values, timestamp };
    console.log(combinedValues);

    const response = await fetch("/api/schedule", {
      method: "POST",
      body: JSON.stringify(combinedValues),
    });
  };

  return (
    <>
      <Form {...form}>
        <form
          onSubmit={form.handleSubmit(onSubmit)}
          className="space-y-8 w-full"
        >
          <FormField
            control={form.control}
            name="email"
            render={({ field }) => (
              <FormItem>
                <FormLabel>Email of Postcard Recipient</FormLabel>
                <FormControl>
                  <Input placeholder="example@gmail.com" {...field} />
                </FormControl
                <FormDescription>
                  Who do you want to send an email to?
                </FormDescription>
                <FormMessage />
              </FormItem>
            )}
          />
          <FormField
            control={form.control}
            name="message"
            render={({ field }) => (
              <FormItem>
                <FormLabel>Postcard Message</FormLabel>
                <FormControl>
                  <Textarea placeholder="Dear Friend..." {...field} />
                </FormControl>
                <FormDescription>
                  Message for your friend or family.
                </FormDescription>
                <FormMessage />
              </FormItem>
            )}
          />
          <FormField
            control={form.control
            name="prompt"
            render={({ field }) => (
              <FormItem>
                <FormLabel>Image Prompt</FormLabel>
                <FormControl>
                  <Textarea
                    placeholder="A beautiful ocean view..."
                    {...field}
                  />
                </FormControl>
                <FormDescription>
                  Prompt for the postcard image.
                </FormDescription
                <FormMessage />
              </FormItem>
            )}
          />
          <FormField
            control={form.control}
            name="date"
            render={({ field }) => (
              <FormItem className="flex flex-col">
                <FormLabel>Date to Send</FormLabel>
                <Popover>
                  <PopoverTrigger asChild>
                    <FormControl>
                      <Button
                        variant={"outline"}
                        className={cn(
                          "w-[240px] pl-3 text-left font-normal",
                          !field.value && "text-muted-foreground"
                        )}
                      >
                        {field.value ? (
                          format(field.value, "PPP")
                        ) : (
                          <span>Pick a date</span>
                        )}
                        <CalendarIcon className="ml-auto h-4 w-4 opacity-50" />
                      </Button>
                    </FormControl>
                  </PopoverTrigger>
                  <PopoverContent className="w-auto p-0" align="start">
                    <Calendar
                      mode="single"
                      selected={field.value}
                      onSelect={field.onChange}
                      disabled={(date) => {
                        const today = new Date();
                        today.setHours(0, 0, 0, 0);
                        const nextWeek = new Date();
                        nextWeek.setDate(today.getDate() + 7);
                        return date > nextWeek || date < today;
                      }}
                      initialFocus
                    />
                  </PopoverContent>
                </Popover
                <FormDescription>
                  Pick a date to send the postcard.
                </FormDescription>
                <FormMessage />
              </FormItem>
            )}
          />
          <FormField
            control={form.control}
            name="time
            render={({ field }) => (
              <FormItem>
                <FormLabel>Time of Day</FormLabel>
                <FormControl>
                  <Select
                    onValueChange={field.onChange}
                    defaultValue={field.value}>
                    <SelectTrigger className="w-[180px]">
                      <SelectValue placeholder="Time of day" />
                    </SelectTrigger>
                    <SelectContent>
                      <SelectItem value="morning">Morning</SelectItem>
                      <SelectItem value="afternoon">Afternoon</SelectItem>
                      <SelectItem value="evening">Evening</SelectItem
                    </SelectContent>
                  </Select
                </FormControl>
                <FormDescription>
                  Time of day to send the postcard.
                </FormDescription>
                <FormMessage />
              </FormItem>
            )}
          />
          <Button variant="outline" type="submit">
            Submit
          </Button>
        </form>
      </Form>
    </>
  );
}
```

![Form](/blog/ai-postcard/form.png)
